name: Release macOS

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for release (e.g., v1.0.0)'
        required: true
        default: 'v0.1.0'

env:
  GO_VERSION: '1.25'

jobs:
  # Build macOS binaries natively
  build-macos-binaries:
    name: Build macOS ${{ matrix.arch }}
    runs-on: macos-latest

    strategy:
      matrix:
        include:
          - arch: amd64
            goarch: amd64
            platform: darwin-amd64
            pkg_arch: x86_64
          - arch: arm64
            goarch: arm64
            platform: darwin-arm64
            pkg_arch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          elif [[ -n "${{ github.event.inputs.tag_name }}" ]]; then
            VERSION=${{ github.event.inputs.tag_name }}
          else
            VERSION="dev-${GITHUB_SHA::8}"
          fi
          # Remove 'v' prefix for package version
          PACKAGE_VERSION="${VERSION#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "package_version=${PACKAGE_VERSION}" >> $GITHUB_OUTPUT

      - name: Build binary
        env:
          GOOS: darwin
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          OUTPUT_NAME="cqlai-${{ matrix.platform }}"
          go build -trimpath -ldflags="-s -w -buildid= -X main.Version=${{ steps.version.outputs.version }}" \
            -o "${OUTPUT_NAME}" \
            ./cmd/cqlai
          chmod +x "${OUTPUT_NAME}"

      - name: Setup temporary installer signing keychain
        uses: apple-actions/import-codesign-certs@v3
        with:
          keychain: signing-${{ matrix.arch }}
          p12-file-base64: ${{ secrets.CSC_INSTALLER_LINK }}
          p12-password: ${{ secrets.CSC_INSTALLER_KEY_PASSWORD }}

      - name: Install fpm
        run: |
          sudo gem install fpm

      - name: Create PKG package
        run: |
          VERSION="${{ steps.version.outputs.package_version }}"
          PLATFORM="${{ matrix.platform }}"
          ARCH="${{ matrix.pkg_arch }}"

          # Code sign the binary (optional - may not have Application cert)
          if command -v codesign > /dev/null; then
            if security find-identity -v -p codesigning | grep -q "Developer ID Application"; then
              codesign --force --options runtime \
                --timestamp \
                -s "Developer ID Application: AXONOPS Limited (UJ776LUP23)" "cqlai-${PLATFORM}"
              echo "Binary code signed successfully"
            else
              echo "Developer ID Application certificate not found, skipping binary code signing"
            fi
          fi

          # Create PKG using fpm (unsigned)
          fpm -s dir -t osxpkg \
            --name cqlai \
            --version "${VERSION}" \
            --architecture "${ARCH}" \
            --license "Apache-2.0" \
            --vendor "AxonOps" \
            --maintainer "AxonOps <support@axonops.com>" \
            --description "AI-powered Cassandra CQL Shell - Modern interactive terminal for Apache Cassandra with AI assistance" \
            --url "https://github.com/axonops/cqlai" \
            --osxpkg-identifier-prefix "com.axonops" \
            "cqlai-${PLATFORM}=/usr/local/bin/cqlai"

          # Rename unsigned package
          mv cqlai-${VERSION}.pkg Unsigned-cqlai.pkg

      - name: Sign and notarize the Apple pkg
        run: |
          VERSION="${{ steps.version.outputs.package_version }}"
          ARCH="${{ matrix.pkg_arch }}"

          # Sign the package
          productsign --sign "Developer ID Installer: AXONOPS Limited (UJ776LUP23)" \
            Unsigned-cqlai.pkg \
            cqlai-${VERSION}-${ARCH}.pkg

          # Clean up unsigned package
          rm -f Unsigned-cqlai.pkg

          # Notarize the package with robust error handling and retry logic
          MAX_ATTEMPTS=3
          ATTEMPT=1
          SUBMISSION_ID=""
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Notarization attempt $ATTEMPT of $MAX_ATTEMPTS..."
            
            # Submit for notarization (don't wait, get submission ID)
            NOTARIZE_OUTPUT=$(xcrun notarytool submit cqlai-${VERSION}-${ARCH}.pkg \
              --apple-id "$APPLE_ID" \
              --team-id "$APPLE_TEAM_ID" \
              --password "$APPLE_APP_SPECIFIC_PASSWORD" \
              2>&1)
            
            NOTARIZE_EXIT_CODE=$?
            
            if [ $NOTARIZE_EXIT_CODE -eq 0 ]; then
              # Extract submission ID from output
              SUBMISSION_ID=$(echo "$NOTARIZE_OUTPUT" | awk '/^  id:/{print $2; exit}')
              
              if [ -z "$SUBMISSION_ID" ]; then
                echo "Error: Could not extract submission ID"
                echo "Output: $NOTARIZE_OUTPUT"
                if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                  ATTEMPT=$((ATTEMPT + 1))
                  echo "Retrying..."
                  sleep 10
                  continue
                else
                  exit 1
                fi
              fi
              
              echo "Submission ID: $SUBMISSION_ID"
              break
            else
              echo "Submission failed with exit code $NOTARIZE_EXIT_CODE"
              echo "Output: $NOTARIZE_OUTPUT"
              
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                ATTEMPT=$((ATTEMPT + 1))
                echo "Retrying in 30 seconds..."
                sleep 30
              else
                exit 1
              fi
            fi
          done
          
          # Poll for notarization status with extended timeout
          POLL_ATTEMPTS=0
          MAX_POLL_ATTEMPTS=120  # 2 hours with 60-second intervals
          POLL_INTERVAL=60
          
          while [ $POLL_ATTEMPTS -lt $MAX_POLL_ATTEMPTS ]; do
            echo "Checking notarization status (attempt $((POLL_ATTEMPTS + 1))/$MAX_POLL_ATTEMPTS)..."
            
            STATUS_OUTPUT=$(xcrun notarytool info "$SUBMISSION_ID" \
              --apple-id "$APPLE_ID" \
              --team-id "$APPLE_TEAM_ID" \
              --password "$APPLE_APP_SPECIFIC_PASSWORD" \
              2>&1)
            
            STATUS_EXIT_CODE=$?
            
            if [ $STATUS_EXIT_CODE -ne 0 ]; then
              echo "Error checking status: $STATUS_OUTPUT"
              POLL_ATTEMPTS=$((POLL_ATTEMPTS + 1))
              sleep $POLL_INTERVAL
              continue
            fi
            
            # Check status
            if echo "$STATUS_OUTPUT" | grep -q "Accepted"; then
              echo "✅ Notarization successful!"
              break
            elif echo "$STATUS_OUTPUT" | grep -q "Rejected\|Invalid"; then
              echo "❌ Notarization rejected or invalid"
              echo "$STATUS_OUTPUT"
              exit 1
            elif echo "$STATUS_OUTPUT" | grep -q "In Progress"; then
              echo "⏳ Notarization in progress..."
              POLL_ATTEMPTS=$((POLL_ATTEMPTS + 1))
              sleep $POLL_INTERVAL
              continue
            else
              echo "Unknown status:"
              echo "$STATUS_OUTPUT"
              POLL_ATTEMPTS=$((POLL_ATTEMPTS + 1))
              sleep $POLL_INTERVAL
              continue
            fi
          done
          
          if [ $POLL_ATTEMPTS -ge $MAX_POLL_ATTEMPTS ]; then
            echo "❌ Notarization timeout - exceeded maximum polling attempts"
            exit 1
          fi
          
          echo "✅ Package signed and notarized successfully"
        env:
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Upload PKG artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-pkg-${{ matrix.platform }}
          path: "*.pkg"

  # Upload to GitHub Release
  upload-to-release:
    name: Upload to GitHub Release
    needs: build-macos-binaries
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'

    steps:
      - name: Download all PKG artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: macos-pkg-*
          merge-multiple: true

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=${{ github.event.inputs.tag_name }}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          files: "*.pkg"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
