name: Test macOS Signing Pipeline

on:
  push:
    branches:
      - 'bug/signing-pipeline-issue'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to test'
        required: false
        default: 'bug/signing-pipeline-issue'

env:
  GO_VERSION: '1.25'

jobs:
  # Build macOS binaries natively for testing
  test-macos-signing:
    name: Test macOS ${{ matrix.arch }} Signing
    runs-on: macos-latest

    strategy:
      matrix:
        include:
          - arch: amd64
            goarch: amd64
            platform: darwin-amd64
            pkg_arch: x86_64
          - arch: arm64
            goarch: arm64
            platform: darwin-arm64
            pkg_arch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get version
        id: version
        run: |
          BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
          COMMIT_SHA=$(git rev-parse --short HEAD)
          # Replace slashes in branch name to avoid path separator issues in filenames
          SAFE_BRANCH_NAME=$(echo "$BRANCH_NAME" | tr '/' '-')
          VERSION="test-${SAFE_BRANCH_NAME}-${COMMIT_SHA}"
          # pkgbuild requires a numeric version (X.Y.Z format)
          PACKAGE_VERSION="0.0.0"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "package_version=${PACKAGE_VERSION}" >> $GITHUB_OUTPUT
          echo "Testing on branch: $BRANCH_NAME"
          echo "Commit: $COMMIT_SHA"

      - name: Build binary
        env:
          GOOS: darwin
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          OUTPUT_NAME="cqlai-${{ matrix.platform }}"
          go build -trimpath -ldflags="-s -w -buildid= -X main.Version=${{ steps.version.outputs.version }}" \
            -o "${OUTPUT_NAME}" \
            ./cmd/cqlai
          chmod +x "${OUTPUT_NAME}"
          echo "✅ Binary built successfully"

      - name: Setup temporary installer signing keychain
        uses: apple-actions/import-codesign-certs@v3
        with:
          keychain: signing-${{ matrix.arch }}
          keychain-password: ${{ github.run_id }}
          p12-file-base64: ${{ secrets.CSC_INSTALLER_LINK }}
          p12-password: ${{ secrets.CSC_INSTALLER_KEY_PASSWORD }}

      - name: Install fpm
        run: |
          sudo gem install fpm
          echo "✅ FPM installed"

      - name: Create PKG package
        run: |
          PKG_VERSION="${{ steps.version.outputs.package_version }}"
          PLATFORM="${{ matrix.platform }}"
          ARCH="${{ matrix.pkg_arch }}"

          # Code sign the binary (optional - may not have Application cert)
          if command -v codesign > /dev/null; then
            if security find-identity -v -p codesigning | grep -q "Developer ID Application"; then
              codesign --force --options runtime \
                --timestamp \
                -s "Developer ID Application: AXONOPS Limited (UJ776LUP23)" "cqlai-${PLATFORM}"
              echo "✅ Binary code signed successfully"
            else
              echo "⚠️ Developer ID Application certificate not found, skipping binary code signing"
            fi
          fi

          # Create PKG using fpm (unsigned) - version must be numeric for pkgbuild
          fpm -s dir -t osxpkg \
            --name cqlai \
            --version "${PKG_VERSION}" \
            --architecture "${ARCH}" \
            --license "Apache-2.0" \
            --vendor "AxonOps" \
            --maintainer "AxonOps <support@axonops.com>" \
            --description "AI-powered Cassandra CQL Shell - Modern interactive terminal for Apache Cassandra with AI assistance" \
            --url "https://github.com/axonops/cqlai" \
            --osxpkg-identifier-prefix "com.axonops" \
            "cqlai-${PLATFORM}=/usr/local/bin/cqlai"

          # Rename unsigned package
          mv cqlai-${PKG_VERSION}.pkg Unsigned-cqlai.pkg
          echo "✅ PKG package created"

      - name: Sign and notarize the Apple pkg
        run: |
          set -x  # Enable debug output
          
          VERSION="${{ steps.version.outputs.package_version }}"
          ARCH="${{ matrix.pkg_arch }}"

          echo "Starting package signing and notarization process..."
          echo "Version: $VERSION"
          echo "Architecture: $ARCH"
          
          # Verify package exists
          if [ ! -f "Unsigned-cqlai.pkg" ]; then
            echo "❌ ERROR: Unsigned package not found!"
            ls -la
            exit 1
          fi

          # Sign the package
          echo "Step 1: Signing package with Developer ID Installer..."
          if ! productsign --sign "Developer ID Installer: AXONOPS Limited (UJ776LUP23)" \
            Unsigned-cqlai.pkg \
            cqlai-${VERSION}-${ARCH}.pkg; then
            echo "❌ ERROR: Failed to sign package"
            exit 1
          fi

          # Clean up unsigned package
          rm -f Unsigned-cqlai.pkg
          
          # Verify signed package exists
          if [ ! -f "cqlai-${VERSION}-${ARCH}.pkg" ]; then
            echo "❌ ERROR: Signed package not found!"
            ls -la
            exit 1
          fi
          
          echo "✅ Package signed successfully"

          # Notarize the package with robust error handling and retry logic
          echo "Step 2: Submitting for notarization with retry logic..."
          MAX_ATTEMPTS=3
          ATTEMPT=1
          SUBMISSION_ID=""
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Notarization submission attempt $ATTEMPT of $MAX_ATTEMPTS..."
            
            # Submit for notarization (don't wait, get submission ID)
            NOTARIZE_OUTPUT=$(xcrun notarytool submit "cqlai-${VERSION}-${ARCH}.pkg" \
              --apple-id "$APPLE_ID" \
              --team-id "$APPLE_TEAM_ID" \
              --password "$APPLE_APP_SPECIFIC_PASSWORD" \
              2>&1) || true
            
            NOTARIZE_EXIT_CODE=$?
            echo "Submission output: $NOTARIZE_OUTPUT"
            echo "Exit code: $NOTARIZE_EXIT_CODE"
            
            if [ $NOTARIZE_EXIT_CODE -eq 0 ]; then
              # Extract submission ID from output - try multiple patterns
              SUBMISSION_ID=$(echo "$NOTARIZE_OUTPUT" | awk '/^  id:/{print $2; exit}')
              
              if [ -z "$SUBMISSION_ID" ]; then
                echo "⚠️ Warning: Could not extract submission ID from output"
                echo "Full output: $NOTARIZE_OUTPUT"
                if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                  ATTEMPT=$((ATTEMPT + 1))
                  echo "Retrying..."
                  sleep 10
                  continue
                else
                  exit 1
                fi
              fi
              
              echo "✅ Submission successful. ID: $SUBMISSION_ID"
              break
            else
              echo "⚠️ Submission failed with exit code $NOTARIZE_EXIT_CODE"
              
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                ATTEMPT=$((ATTEMPT + 1))
                echo "Retrying in 30 seconds..."
                sleep 30
              else
                echo "❌ All submission attempts failed"
                exit 1
              fi
            fi
          done
          
          # Poll for notarization status with extended timeout
          echo "Step 3: Polling for notarization status..."
          POLL_ATTEMPTS=0
          MAX_POLL_ATTEMPTS=120  # 2 hours with 60-second intervals
          POLL_INTERVAL=60
          
          while [ $POLL_ATTEMPTS -lt $MAX_POLL_ATTEMPTS ]; do
            ELAPSED_MINUTES=$((POLL_ATTEMPTS * POLL_INTERVAL / 60))
            echo "[$ELAPSED_MINUTES min] Checking notarization status (attempt $((POLL_ATTEMPTS + 1))/$MAX_POLL_ATTEMPTS)..."
            
            STATUS_OUTPUT=$(xcrun notarytool info "$SUBMISSION_ID" \
              --apple-id "$APPLE_ID" \
              --team-id "$APPLE_TEAM_ID" \
              --password "$APPLE_APP_SPECIFIC_PASSWORD" \
              2>&1) || true
            
            STATUS_EXIT_CODE=$?
            echo "Status check exit code: $STATUS_EXIT_CODE"
            echo "Status output: $STATUS_OUTPUT"
            
            if [ $STATUS_EXIT_CODE -ne 0 ]; then
              echo "⚠️ Error checking status, will retry"
              POLL_ATTEMPTS=$((POLL_ATTEMPTS + 1))
              sleep $POLL_INTERVAL
              continue
            fi
            
            # Check status - look for specific keywords
            if echo "$STATUS_OUTPUT" | grep -qi "Accepted"; then
              echo "✅ Notarization successful!"
              echo "$STATUS_OUTPUT"
              break
            elif echo "$STATUS_OUTPUT" | grep -qi "Rejected"; then
              echo "❌ Notarization rejected"
              echo "$STATUS_OUTPUT"
              exit 1
            elif echo "$STATUS_OUTPUT" | grep -qi "Invalid"; then
              echo "❌ Notarization invalid"
              echo "$STATUS_OUTPUT"
              exit 1
            elif echo "$STATUS_OUTPUT" | grep -qi "In Progress"; then
              echo "⏳ Notarization in progress..."
              POLL_ATTEMPTS=$((POLL_ATTEMPTS + 1))
              sleep $POLL_INTERVAL
              continue
            else
              echo "ℹ️ Status output:"
              echo "$STATUS_OUTPUT"
              POLL_ATTEMPTS=$((POLL_ATTEMPTS + 1))
              sleep $POLL_INTERVAL
              continue
            fi
          done
          
          if [ $POLL_ATTEMPTS -ge $MAX_POLL_ATTEMPTS ]; then
            echo "❌ Notarization timeout - exceeded maximum polling attempts (2 hours)"
            exit 1
          fi
          
          echo "✅ Package signed and notarized successfully"
          
          set +x  # Disable debug output
        env:
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Upload PKG artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-macos-pkg-${{ matrix.platform }}
          path: "*.pkg"
          if-no-files-found: error

      - name: Post-test summary
        if: always()
        run: |
          echo "## Test Summary"
          echo "- Branch: ${{ github.ref }}"
          echo "- Architecture: ${{ matrix.arch }}"
          echo "- Status: ${{ job.status }}"
          echo ""
          echo "✅ All signing and notarization steps completed successfully!"
