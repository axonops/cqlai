# SAVEコマンドドキュメント

## 概要

CQLAIの`SAVE`コマンドを使用すると、クエリを再実行せずに現在表示されているクエリ結果をファイルにエクスポートできます。これは、既にクエリを実行済みで、異なる形式で結果をエクスポートしたい場合や、実行に時間がかかる大きな結果セットを操作している場合に特に便利です。

## 主な機能

- **再実行なし**: ターミナルに現在表示されている結果をそのまま保存
- **複数の形式**: CSV、JSON、ASCIIテーブル形式をサポート
- **対話モード**: 形式とファイル名を選択するシンプルなダイアログ
- **自動検出**: ファイル拡張子から形式を自動検出
- **スマートJSON処理**: OUTPUT JSONモードが使用されている場合、JSON構造を保持

## 構文

```sql
SAVE [filename] [format]
```

### パラメータ

- **filename**(オプション): 出力ファイルへのパス。省略すると対話ダイアログが開きます。
- **format**(オプション): 出力形式(CSV、JSON、ASCII)。省略すると拡張子から自動検出されます。

## 使用例

### 対話モード

```sql
-- まずクエリを実行
SELECT * FROM users WHERE created_at > '2024-01-01';

-- 対話型保存ダイアログを開く
SAVE
-- ダイアログでプロンプトが表示されます:
-- 1. 形式選択(CSV/JSON/ASCII)
-- 2. ファイル名入力
```

### 自動検出での直接保存

```sql
-- CSVに保存(.csv拡張子から検出)
SAVE 'users.csv'

-- JSONに保存(.json拡張子から検出)
SAVE 'users.json'

-- ASCIIテーブルとしてテキストファイルに保存
SAVE 'users.txt' ASCII
```

### 明示的な形式指定

```sql
-- 拡張子に関係なくCSV形式を強制
SAVE 'output.data' CSV

-- JSON形式を強制
SAVE 'output.data' JSON

-- ASCIIテーブル形式を強制
SAVE 'output.data' ASCII
```

## 形式の詳細

### CSV形式
- デフォルトでヘッダーを含む
- 特殊文字を適切にエスケープ
- ANSIカラーコードを削除
- カラム名からキーインジケーター(PK)、(C)を削除

出力例:
```csv
id,name,email,created_at
1,John Doe,john@example.com,2024-01-15
2,Jane Smith,jane@example.com,2024-01-16
```

### JSON形式
- オブジェクトの配列を作成
- 各行がカラム名をキーとするJSONオブジェクトになります
- スマート検出: OUTPUT JSONが使用された場合、元のJSON構造を保持
- 読みやすさのためにプリティプリント

出力例:
```json
[
  {
    "id": "1",
    "name": "John Doe",
    "email": "john@example.com",
    "created_at": "2024-01-15"
  },
  {
    "id": "2",
    "name": "Jane Smith",
    "email": "jane@example.com",
    "created_at": "2024-01-16"
  }
]
```

### ASCII形式
- 境界線付きのフォーマットされたテーブル
- カラムの配置を保持
- ドキュメントやレポートに適しています

出力例:
```
+----+------------+------------------+------------+
| id | name       | email            | created_at |
+----+------------+------------------+------------+
| 1  | John Doe   | john@example.com | 2024-01-15 |
| 2  | Jane Smith | jane@example.com | 2024-01-16 |
+----+------------+------------------+------------+
```

## CAPTUREとの違い

| 機能 | SAVE | CAPTURE |
|---------|------|---------|
| **目的** | 表示された結果をエクスポート | 今後のクエリ出力を記録 |
| **タイミング** | クエリ実行後 | クエリ実行前 |
| **再実行** | なし | あり(後続のすべてのクエリを記録) |
| **対話的** | あり(ダイアログ利用可能) | なし |
| **使用ケース** | 既存の結果をエクスポート | セッションアクティビティをログ記録 |

### SAVEを使用する場合

- 再実行したくない複雑なクエリを実行した後
- 複数の形式で結果が必要な場合
- ページ分割された結果をエクスポートする場合(ロードされたページのみ保存)
- 共有するためのクエリ結果の迅速なエクスポート

### CAPTUREを使用する場合

- セッション全体を記録する場合
- 予測可能な出力での自動スクリプト
- 複数のクエリの継続的なログ記録
- エラーと警告をキャプチャする必要がある場合

## ページ分割された結果の操作

`AUTOFETCH OFF`が設定されていてページ分割された結果がある場合:

```sql
-- 手動ページネーションを設定
AUTOFETCH OFF;

-- クエリを実行(最初のページをロード)
SELECT * FROM large_table;

-- 必要に応じてより多くのページをロード
-- (PgDnまたはSpaceを押す)

-- ロードされたページのみを保存
SAVE 'partial_results.csv'
```

**注意**: SAVEはロードされて表示されたデータのみをエクスポートします。すべてのページが必要な場合は、次のいずれかを行ってください:
1. クエリを実行する前に`AUTOFETCH ON`を設定する、または
2. 保存する前にすべての結果を手動でページングする

## ファイルパス処理

- **相対パス**: 現在の作業ディレクトリからの相対パスで保存
- **絶対パス**: `/`(Unix)またはドライブレター(Windows)で始まるフルパスを使用
- **ホームディレクトリ**: ホームディレクトリの展開には`~/`を使用
- **パス内のスペース**: 単一引用符で囲む

例:
```sql
SAVE 'output.csv'                    -- 現在のディレクトリ
SAVE '/tmp/results.json'             -- 絶対パス
SAVE '~/Documents/data.csv'          -- ホームディレクトリ
SAVE '/path with spaces/file.csv'    -- スペースを含むパス
```

## エラー処理

一般的なエラーシナリオ:

```sql
-- 保存するクエリ結果がない
SAVE 'output.csv'
-- エラー: エクスポートするデータがありません

-- 無効なパス
SAVE '/invalid/path/file.csv'
-- エラー: ファイルの作成に失敗しました

-- パーミッション拒否
SAVE '/root/protected.csv'
-- エラー: パーミッションが拒否されました
```

## ヒントとベストプラクティス

1. **最初に結果を確認**: 保存する前に常に表示されたデータを確認してください
2. **意味のあるファイル名を使用**: ファイル名に日付やクエリコンテキストを含めてください
3. **適切な形式を選択**:
   - Excel/スプレッドシートインポート用にCSV
   - API統合やNoSQLデータベース用にJSON
   - ドキュメントやプレーンテキストレポート用にASCII
4. **大きな結果を処理**: 非常に大きな結果セットの場合は、代わりに`COPY TO`の使用を検討してください
5. **JSON構造を保持**: `OUTPUT JSON`を使用する場合は、構造を維持するためにJSONとして保存してください

## OUTPUTモードとの統合

SAVEコマンドは現在のOUTPUTモードを尊重します:

```sql
-- デフォルトのTABLEモード
SELECT * FROM users;
SAVE 'users.csv'  -- 構造化データを保存

-- JSON出力モード
OUTPUT JSON;
SELECT * FROM users;
SAVE 'users.json'  -- 再エンコードせずにJSON形式を保持

-- ASCIIモード
OUTPUT ASCII;
SELECT * FROM users;
SAVE 'users.txt' ASCII  -- フォーマットされたASCIIテーブルを保存
```

## キーボードショートカット

SAVEに直接関連していませんが、これらのショートカットは保存前に結果をナビゲートするのに役立ちます:

- **PgUp/PgDn**: 結果をページングする
- **Space**: 次のページをロード(AUTOFETCH OFFの場合)
- **Esc**: ページング操作をキャンセル
- **Alt+←/→**: 幅広いテーブルを水平スクロール

## 参照

- [CAPTUREコマンド](./CAPTURE_COMMAND.md) - 継続的な出力記録用
- [COPY TOコマンド](./COPY_COMMAND.md) - 完全な制御でのテーブルの直接エクスポート用
- [OUTPUTコマンド](./OUTPUT_COMMAND.md) - 表示形式の変更用
